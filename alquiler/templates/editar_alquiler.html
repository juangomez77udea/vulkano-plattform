{% extends 'index.html' %}
{% load humanize %}

{% block breadcrumb %}
  {% include 'breadcrumb.html' with home='/' breadcrumbs=breadcrumb_items %}
{% endblock %}

{% block content %}
  <div class="max-w-5xl mx-auto mt-6 bg-white p-4 rounded shadow">
    <div class="flex justify-between items-center mb-2">
      <h2 class="text-xl font-bold text-gray-800">
        Alquiler #{{ alquiler.id }}
        <span class="inline-block text-xs px-2 py-1 rounded-full
                    {% if alquiler.estado == 'borrador' %}
            
            
            
            
            
                      
                      bg-gray-100 text-gray-800






          {% elif alquiler.estado == 'en_curso' %}
            
            
            
            
            
            
                      bg-blue-100 text-blue-800






          {% elif alquiler.estado == 'con_abono' %}
            
            
            
            
            
            
                      bg-yellow-100 text-yellow-800






          {% elif alquiler.estado == 'liquidado' %}
            
            
            
            
            
            
                      bg-green-100 text-green-800






          {% elif alquiler.estado == 'anulado' %}
            
            
            
            
            
            
                      bg-red-100 text-red-800






          {% endif %}">
          {{ alquiler.get_estado_display }}
        </span>
      </h2>
      <div class="flex gap-3">
        <a href="{% url 'imprimir_alquiler' alquiler.id %}" target="_blank" class="text-sm bg-[var(--primary-color)] text-white px-4 py-2 rounded-xl hover:bg-blue-800 transition shadow">üñ®Ô∏è Imprimir</a>

       {% if alquiler.estado != 'liquidado' and alquiler.estado != 'anulado' %}
          <a href="#" id="btn-liquidar" data-url="{% url 'liquidar_alquiler' alquiler.id %}" class="bg-green-700 hover:bg-green-800 text-white text-sm px-4 py-2 rounded-xl transition shadow">üí∞ Liquidar</a>
        {% endif %}
        <a href="{% url 'alquiler_list' %}" class="text-sm text-[var(--primary-color)] hover:underline">‚Üê Volver</a>
      </div>
    </div>

    <!-- Secci√≥n: Agregar producto -->
    <div class="border-t border-gray-200 pt-2 mt-2">
      <h3 class="text-xl font-semibold text-gray-800 mb-2">Agregar producto al alquiler</h3>
      <form method="post" action="{% url 'editar_alquiler' alquiler.id %}" class="grid grid-cols-3 gap-4 items-end">
        {% csrf_token %}
        {{ item_form.non_field_errors }}

        <div class="col-span-3 flex flex-wrap items-end gap-4">
          <div class="w-[40%]">
            <label class="block text-sm font-medium text-gray-700">Buscar producto</label>
            <input type="text" id="buscar-producto" class="w-full p-2 border border-gray-300 rounded" placeholder="Escribe al menos 3 letras..." autofocus />
            <ul id="resultados-productos" class="border mt-1 rounded shadow bg-white hidden absolute z-10 max-h-48 overflow-y-auto"></ul>
            <input type="hidden" name="producto" id="producto-id" />
          </div>

          <div class="w-[25%]">
            <label class="block text-sm font-medium text-gray-700">D√≠as a cobrar</label>
            {{ item_form.dias_a_cobrar }}
          </div>

          <div class="w-[25%]">
            <label class="block text-sm font-medium text-gray-700">Cantidad</label>
            {{ item_form.cantidad }}
          </div>
        </div>

        <div class="col-span-3">
          <button type="submit" class="mt-2 w-full bg-[var(--primary-color)] text-white py-2 rounded hover:bg-blue-700 transition">Agregar producto</button>
        </div>
      </form>
    </div>

    <!-- Tabla productos -->
    <div class="mt-6">
      <div class="flex justify-between items-center mb-2">
        <h3 class="text-xl font-semibold text-gray-800">Productos del alquiler</h3>
        <span class="text-lg font-semibold text-gray-700">Total a pagar: ${{ total|floatformat:0|intcomma }}</span>
      </div>
      <table class="min-w-full bg-white border border-gray-300 rounded text-sm">
        <thead class="bg-gray-100">
          <tr>
            <th class="text-left p-2">Producto</th>
            <th class="text-left p-2">Cantidad</th>
            <th class="text-left p-2">D√≠as</th>
            <th class="text-left p-2">Precio/d√≠a</th>
            <th class="text-left p-2">Subtotal</th>
            <th class="text-left p-2">IVA</th>
            <th class="text-left p-2">Descuento</th>
            <th class="text-left p-2">Total</th>
            <th class="text-left p-2">Acciones</th>
          </tr>
        </thead>
        <tbody>
          {% for item in alquiler.items.all %}
            <tr class="border-t">
              <td class="p-2">{{ item.producto }}</td>

              {% if item.cantidad %}
                <td class="p-2">{{ item.cantidad }}</td>
              {% else %}
                <td class="p-2">1</td>
              {% endif %}
              <td class="p-2">{{ item.dias_a_cobrar }}</td>
              <td class="p-2">${{ item.precio_dia|floatformat:0|intcomma }}</td>
              <td class="p-2">${{ item.subtotal_item|floatformat:1|intcomma }}</td>
              <td class="p-2">${{ item.valor_iva|floatformat:1|intcomma }}</td>
              <td class="p-2 text-red-600">-${{ item.valor_descuento|floatformat:0|intcomma }}</td>
              <td class="p-2 font-semibold">${{ item.valor_item|floatformat:0|intcomma }}</td>
              <td class="p-2">
                <a href="{% url 'eliminar_item_alquiler' item.id %}" class="text-red-600 hover:text-red-800" title="Eliminar"><i class="ph ph-trash-simple text-xl"></i></a>
              </td>
            </tr>
          {% empty %}
            <tr>
              <td colspan="7" class="p-2 text-center text-gray-500">No hay productos agregados.</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- Formulario: datos generales -->
    <form method="post" class="mt-6">
      {% csrf_token %}
      <h3 class="text-base font-semibold text-gray-800 mb-2">Datos generales del alquiler</h3>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="col-span-2">
          <label class="block text-sm font-medium text-gray-700">Buscar cliente</label>
          <input type="text" id="buscar-cliente" value="{{ form.instance.cliente.nombre }} {{ form.instance.cliente.apellidos }}" class="w-full p-2 border border-gray-300 rounded" placeholder="Escribe al menos 3 letras..." />
          <ul id="resultados-clientes" class="border mt-1 rounded shadow bg-white hidden absolute z-10 max-h-48 overflow-y-auto"></ul>
          <input type="hidden" name="cliente" id="cliente-id" value="{{ form.instance.cliente.id|default:'' }}" />
        </div>
        <div class="col-span-2 flex flex-wrap items-end gap-4 w-full items-baseline">
          <!-- Observaciones -->
          <div class="min-w-[250px]">
            <label for="{{ form.observaciones.id_for_label }}" class="block text-sm font-medium text-gray-700">Observaciones</label>
            {{ form.observaciones }}
          </div>

          <!-- Fecha de inicio -->
          <div class="w-[25%] min-w-[180px]">
            <label for="{{ form.fecha_inicio.id_for_label }}" class="block text-sm font-medium text-gray-700">Inicio</label>
            {{ form.fecha_inicio }}
          </div>

          <!-- Fecha de fin -->
          <div class="w-[25%] min-w-[180px]">
            <label for="{{ form.fecha_fin.id_for_label }}" class="block text-sm font-medium text-gray-700">Fin</label>
            {{ form.fecha_fin }}
          </div>
        </div>
      </div>

      <div class="mt-4">
        <button type="submit" class="w-full bg-[var(--primary-color)] text-white py-1.5 px-3 text-sm rounded hover:bg-blue-700 transition">Guardar</button>
      </div>
    </form>
    <!-- Aplicar descuento -->
    <div class="mt-8 border-t pt-4 mb-2">
      <h3 class="text-lg font-semibold text-gray-800 mb-2">Descuentos aplicables</h3>

      <div class="flex justify-between items-center mb-2">
        <span class="text-sm text-gray-600">Puedes aplicar un descuento general o por producto.</span>
        <a href="{% url 'descuento_list' %}" class="bg-blue-800 hover:bg-blue-900 text-white text-sm px-3 py-1 rounded">Gestionar descuentos</a>
        <a href="{% url 'limpiar_descuentos' alquiler.id %}" class="bg-blue-800 hover:bg-blue-900 text-white text-sm px-3 py-1 rounded">Quitar descuentos</a>
      </div>

      {% if descuentos %}
        <table class="min-w-full bg-white border border-gray-300 rounded text-sm">
          <thead class="bg-gray-100">
            <tr>
              <th class="text-left p-2">Tipo</th>
              <th class="text-left p-2">Porcentaje</th>
              <th class="text-left p-2">Descripci√≥n</th>
              <th class="text-left p-2">Acci√≥n</th>
            </tr>
          </thead>
          <tbody>
            {% for d in descuentos %}
              <tr class="border-t">
                <td class="p-2">{{ d.get_tipo_display }}</td>
                <td class="p-2">{{ d.porcentaje|floatformat:2 }}%</td>
                <td class="p-2">{{ d.descripcion }}</td>
                <td class="p-2">
                  <form method="post" action="{% url 'aplicar_descuento_alquiler' alquiler.id %}">
                    {% csrf_token %}
                    <input type="hidden" name="descuento_id" value="{{ d.id }}" />
                    <button class="bg-green-600 text-white px-2 py-1 rounded text-xs hover:bg-green-700">Aplicar</button>
                  </form>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      {% else %}
        <p class="text-sm text-gray-500 italic">No hay descuentos activos configurados para tu empresa.</p>
      {% endif %}
    </div>
    <a href="#" class="bg-red-800 hover:bg-red-900 text-white text-md px-3 py-1 rounded" id="btn-anular" data-url="{% url 'anular_alquiler' alquiler.id %}">Anular</a>
  </div>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      // Buscar productos
      const input = document.getElementById('buscar-producto')
      const lista = document.getElementById('resultados-productos')
      const hiddenInput = document.getElementById('producto-id')
      let selectedIndex = -1
    
      input.addEventListener('input', function () {
        const query = input.value.trim()
        if (query.length >= 3) {
          fetch(`/alquiler/productos-buscar/?q=${query}`)
            .then((res) => {
              if (!res.ok) {
                return res.json().then((error) => {
                  throw new Error(error.error || 'No se encontraron resultados.')
                })
              }
              return res.json()
            })
            .then((data) => {
              lista.innerHTML = ''
              selectedIndex = -1
    
              data.forEach((producto, index) => {
                const li = document.createElement('li')
                li.textContent = producto.nombre
                li.classList = 'px-4 py-2 hover:bg-gray-100 cursor-pointer'
                li.addEventListener('click', () => {
                  input.value = producto.nombre
                  hiddenInput.value = producto.id
                  lista.classList.add('hidden')
                })
                lista.appendChild(li)
              })
    
              lista.classList.remove('hidden')
            })
            .catch((error) => {
              Swal.fire({
                icon: 'warning',
                title: 'Producto no encontrado',
                text: error.message,
                timer: 3000,
                timerProgressBar: true,
                showConfirmButton: false
              })
              lista.classList.add('hidden')
            })
        } else {
          lista.classList.add('hidden')
        }
      })
    
      input.addEventListener('keydown', function (e) {
        const items = lista.querySelectorAll('li')
        if (lista.classList.contains('hidden') || items.length === 0) return
    
        if (e.key === 'ArrowDown') {
          e.preventDefault()
          selectedIndex = (selectedIndex + 1) % items.length
        } else if (e.key === 'ArrowUp') {
          e.preventDefault()
          selectedIndex = (selectedIndex - 1 + items.length) % items.length
        } else if (e.key === 'Enter') {
          e.preventDefault()
          if (selectedIndex >= 0) {
            items[selectedIndex].click()
          }
        }
    
        items.forEach((item, i) => {
          item.classList.toggle('bg-blue-100', i === selectedIndex)
          item.classList.toggle('text-blue-800', i === selectedIndex)
          item.classList.toggle('font-semibold', i === selectedIndex)
        })
      })
    })
  </script>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      // Buscar clientes
      const inputCliente = document.getElementById('buscar-cliente')
      const listaClientes = document.getElementById('resultados-clientes')
      const hiddenCliente = document.getElementById('cliente-id')
      let selectedClienteIndex = -1
    
      inputCliente.addEventListener('input', function () {
        const query = inputCliente.value.trim()
        if (query.length >= 3) {
          fetch(`/alquiler/clientes-buscar/?q=${query}`)
            .then((res) => {
              if (!res.ok) {
                return res.json().then((error) => {
                  throw new Error(error.error || 'No se encontraron resultados.')
                })
              }
              return res.json()
            })
            .then((data) => {
              listaClientes.innerHTML = ''
              selectedClienteIndex = -1
    
              data.forEach((cliente, index) => {
                const li = document.createElement('li')
                li.textContent = cliente.nombre
                li.classList = 'px-4 py-2 hover:bg-gray-100 cursor-pointer'
                li.addEventListener('click', () => {
                  inputCliente.value = cliente.nombre
                  hiddenCliente.value = cliente.id
                  listaClientes.classList.add('hidden')
                })
                listaClientes.appendChild(li)
              })
    
              listaClientes.classList.remove('hidden')
            })
            .catch((error) => {
              Swal.fire({
                icon: 'warning',
                title: 'Cliente no encontrado',
                text: error.message,
                timer: 3000,
                timerProgressBar: true,
                showConfirmButton: false
              })
              listaClientes.classList.add('hidden')
            })
        } else {
          listaClientes.classList.add('hidden')
        }
      })
    
      inputCliente.addEventListener('keydown', function (e) {
        const items = listaClientes.querySelectorAll('li')
        if (listaClientes.classList.contains('hidden') || items.length === 0) return
    
        if (e.key === 'ArrowDown') {
          e.preventDefault()
          selectedClienteIndex = (selectedClienteIndex + 1) % items.length
        } else if (e.key === 'ArrowUp') {
          e.preventDefault()
          selectedClienteIndex = (selectedClienteIndex - 1 + items.length) % items.length
        } else if (e.key === 'Enter') {
          e.preventDefault()
          if (selectedClienteIndex >= 0) {
            items[selectedClienteIndex].click()
          }
        }
    
        items.forEach((item, i) => {
          item.classList.toggle('bg-blue-100', i === selectedClienteIndex)
          item.classList.toggle('text-blue-800', i === selectedClienteIndex)
          item.classList.toggle('font-semibold', i === selectedClienteIndex)
        })
      })
    })
  </script>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const btnAnular = document.getElementById('btn-anular')
      if (btnAnular) {
        btnAnular.addEventListener('click', function (e) {
          e.preventDefault()
          const url = this.getAttribute('data-url')
          Swal.fire({
            title: '¬øEst√°s seguro?',
            text: 'Esta acci√≥n anular√° el alquiler y no se podr√° editar.',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'S√≠, anular',
            cancelButtonText: 'Cancelar'
          }).then((result) => {
            if (result.isConfirmed) {
              window.location.href = url
            }
          })
        })
      }
    })
  </script>

  <script>
  document.addEventListener('DOMContentLoaded', function () {
    const btnLiquidar = document.getElementById('btn-liquidar');
    if (btnLiquidar) {
      btnLiquidar.addEventListener('click', function (e) {
        e.preventDefault();
        const url = this.getAttribute('data-url');
        Swal.fire({
          title: '¬øLiquidar alquiler?',
          text: "Esta acci√≥n registrar√° el alquiler como finalizado y no ser√° editable.",
          icon: 'question',
          showCancelButton: true,
          confirmButtonColor: '#3085d6',
          cancelButtonColor: '#aaa',
          confirmButtonText: 'S√≠, liquidar',
          cancelButtonText: 'Cancelar'
        }).then((result) => {
          if (result.isConfirmed) {
            window.location.href = url;
          }
        });
      });
    }
  });
</script>

{% endblock %}
